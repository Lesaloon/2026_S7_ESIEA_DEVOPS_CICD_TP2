# Nom du workflow tel qu’il apparaîtra dans GitHub Actions
name: CI/CD Pipeline

# Déclencheurs du pipeline
on:
  # Le pipeline s’exécute à chaque Pull Request
  pull_request:
  # Le pipeline s’exécute aussi à chaque push sur la branche main
  push:
    branches: [main]

jobs:
  # =====================================================
  # 1. VALIDATION DU CODE (Linting & qualité)
  # =====================================================
  lint:
    # Nom lisible du job dans l’interface GitHub
    name: Lint & Qualité du code

    # Environnement d’exécution (machine virtuelle Linux)
    runs-on: ubuntu-latest

    steps:
      # Étape 1 : récupération du code source
      - name: Checkout du code
        uses: actions/checkout@v4

      # Étape 2 : installation de Python
      - name: Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Étape 3 : installation de l’outil de linting
      - name: Installer dépendances
        run: |
          pip install ruff

      # Étape 4 : analyse statique du code
      # Objectif : échouer rapidement si le code est non conforme
      - name: Linting (fail fast)
        run: |
          ruff check .

  # =====================================================
  # 2. TESTS UNITAIRES (transformations de données)
  # =====================================================
  unit-tests:
    name: Tests unitaires (transformations data)

    # Le job ne démarre que si le linting a réussi
    needs: lint

    runs-on: ubuntu-latest

    steps:
      # Récupération du code
      - uses: actions/checkout@v4

      # Installation de Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Installation des dépendances du projet + pytest
      - name: Installer dépendances
        run: |
          pip install -r requirements.txt
          pip install pytest

      # Exécution des tests unitaires
      # Ici : fonctions de transformation, nettoyage, calculs KPI
      - name: Lancer tests unitaires
        run: |
          pytest tests/unit

  # =====================================================
  # 3. TESTS D’INTÉGRATION (base de données + données)
  # =====================================================
  integration-tests:
    name: Tests d’intégration (base + données)

    # Dépend des tests unitaires
    needs: unit-tests

    runs-on: ubuntu-latest

    steps:
      # Récupération du code
      - uses: actions/checkout@v4

      # Installation de Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Installation des dépendances nécessaires aux tests DB
      - name: Installer dépendances
        run: |
          pip install -r requirements.txt
          pip install pytest

      # Exécution des tests d’intégration
      # Objectif : tester les requêtes SQL, le schéma et les interactions réelles
      - name: Lancer tests d’intégration
        run: |
          pytest tests/integration

  # =====================================================
  # 4. TESTS DE PERFORMANCE (simples)
  # =====================================================
  performance-tests:
    name: Validation des performances

    # Ne démarre que si les tests d’intégration passent
    needs: integration-tests

    runs-on: ubuntu-latest

    steps:
      # Récupération du code
      - uses: actions/checkout@v4

      # Installation de Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Installation des outils de benchmark
      - name: Installer dépendances
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-benchmark

        # Exécution de benchmarks légers
        # Objectif : détecter des régressions de performance
      - name: Benchmarks légers
        run: |
          pytest tests/performance --benchmark-only

  # =====================================================
  # 5. BUILD & PUSH DOCKER IMAGE TO GHCR
  # =====================================================
  docker-publish:
    name: Build and publish Docker image to GHCR

    # Ne démarre que si tous les tests passent
    needs: performance-tests

    # Seulement sur push à la branche main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest

    steps:
      # Récupération du code
      - name: Checkout du code
        uses: actions/checkout@v4

        # Build et push l'image Docker vers GHCR
      - name: Build and publish Docker image to ghcr.io
        uses: macbre/push-to-ghcr@master
        with:
          image_name: ${{ github.repository }}
          github_token: ${{ secrets.GHCR_TOKEN }}

        # Vérifier que l'image a bien été poussée vers GHCR
      - name: Verify Docker image was pushed successfully
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository }}"
          IMAGE_TAG="latest"

          # Utiliser gh CLI pour vérifier l'existence de l'image
          gh api repos/${{ github.repository }}/packages \
            --jq '.[] | select(.package_type == "container" and .name == "2026_s7_esiea_devops_cicd_tp2")' \
            || (echo "Image verification failed"; exit 1)

          echo "✓ Docker image successfully pushed to GHCR"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        # Installer Kompose pour convertir docker-compose en manifests Kubernetes
      - name: Install Kompose
        run: |
          curl -L https://github.com/kubernetes/kompose/releases/download/v1.32.0/kompose-linux-amd64 -o kompose
          chmod +x kompose
          sudo mv kompose /usr/local/bin/

      # Générer les manifests Kubernetes à partir du docker-compose
      - name: Generate Kubernetes manifests with Kompose
        run: |
          mkdir -p k8s-manifests
          cd k8s-manifests
          kompose -f ../docker-compose.prod.yml convert -o .

          echo "Generated manifests:"
          ls -la

      # Créer le dossier GuillianCarvillePython avec les manifests
      - name: Organize manifests and create submission folder
        run: |
          mkdir -p GuillianCarvillePython
          cp k8s-manifests/* GuillianCarvillePython/

          echo "Contents of GuillianCarvillePython:"
          ls -la GuillianCarvillePython/

      # Zipper le dossier GuillianCarvillePython
      - name: Create deployment archive
        run: |
          zip -r GuillianCarvillePython.zip GuillianCarvillePython/

          ls -lh GuillianCarvillePython.zip
          echo "Archive created successfully"

      # Uploader le zip vers le serveur FTP
      - name: Upload to FTP server
        run: |
          set -e
          if [ -z "${{ secrets.FTP_HOST }}" ]; then
            echo "⚠️  FTP credentials not yet configured"
            echo "Archive ready at: GuillianCarvillePython.zip"
            exit 0
          fi

          sudo apt-get update -qq
          sudo apt-get install -y lftp
          lftp -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }} << EOF
          set ssl:verify-certificate no
          mkdir -p RenduDevopsKube 2>/dev/null || true
          cd RenduDevopsKube;
          put GuillianCarvillePython.zip;
          quit
          EOF

          echo "✓ Archive successfully uploaded to FTP"
